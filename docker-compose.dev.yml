# Development overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

version: '3.8'

services:
  # PostgreSQL with development settings
  postgres:
    environment:
      POSTGRES_USER: mycelix
      POSTGRES_PASSWORD: mycelix_dev_pass
      POSTGRES_DB: mycelix_music
    ports:
      - "5432:5432"

  # Redis with development settings
  redis:
    command: redis-server --appendonly yes --requirepass ""
    ports:
      - "6379:6379"

  # API with hot reload and debugging
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
      args:
        NODE_ENV: development
    environment:
      NODE_ENV: development
      DEBUG: mycelix:*
      LOG_LEVEL: debug
    volumes:
      - ./apps/api:/app/apps/api
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/api/node_modules
    ports:
      - "3100:3100"
      - "9229:9229"  # Node.js debugger
    command: npm run dev --workspace=apps/api

  # Frontend with hot reload
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
      args:
        NODE_ENV: development
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/web/node_modules
      - /app/apps/web/.next
    ports:
      - "3000:3000"
    command: npm run dev --workspace=apps/web

  # Local blockchain (Anvil)
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: mycelix-music-anvil
    restart: unless-stopped
    ports:
      - "8545:8545"
    command: >
      anvil
      --host 0.0.0.0
      --port 8545
      --block-time 1
      --accounts 10
      --balance 10000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Adminer for database management (optional)
  adminer:
    image: adminer:latest
    container_name: mycelix-music-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres

  # Redis Commander for Redis management (optional)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: mycelix-music-redis-commander
    restart: unless-stopped
    ports:
      - "8082:8081"
    environment:
      REDIS_HOSTS: local:redis:6379
    depends_on:
      - redis
